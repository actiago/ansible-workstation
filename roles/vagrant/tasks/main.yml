---
- name: Verifica se Vagrant est√° instalado
  shell: dpkg-query --showformat='${Version}' --show vagrant || true
  register: check_vagrant
  changed_when: false
  tags: vagrant:install

- name: Instala Vagrant
  apt:
    deb: https://releases.hashicorp.com/vagrant/{{ vagrant_version }}/vagrant_{{ vagrant_version }}_{{ ansible_architecture }}.deb
    state: present
  when: check_vagrant.stdout[2:] != vagrant_version
  tags: vagrant:install

- name: Instala plugins
  command: vagrant plugin install {{ item }}
  with_items: "{{ vagrant_plugins.split(',') }}"
  become: yes
  become_user: "{{ vagrant_user | default(lookup('env', 'USER')) }}"
  changed_when: false
  tags: vagrant:plugins

- name: Configura sudoers para vagrant-hostsupdater
  copy:
    src: vagrant-hostsupdater.sudoers
    dest: /etc/sudoers.d/vagrant-hostsupdater
    owner: root
    group: root
    mode: 0440
    validate: "visudo -cf %s"
  when: "'vagrant-hostsupdater' in vagrant_plugins.split(',')"
  tags: vagrant:plugins
